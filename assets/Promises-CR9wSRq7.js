var L=e=>{throw TypeError(e)};var S=(e,t,o)=>t.has(e)||L("Cannot "+o);var h=(e,t,o)=>(S(e,t,"read from private field"),o?o.call(e):t.get(e)),b=(e,t,o)=>t.has(e)?L("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,o),d=(e,t,o,c)=>(S(e,t,"write to private field"),c?c.call(e,o):t.set(e,o),o),m=(e,t,o)=>(S(e,t,"access private method"),o);import{r as p,j as n}from"./index-DZxVDkqq.js";import{_ as x}from"./services-Bu_7CigI.js";function y(e,t=!1){let o=0,c=Date.now();for(;Date.now()-c<e;)o++;t&&console.log(`Counted ${o.toLocaleString()} sheep while sleeping.`)}const B=({logger:e=null})=>{e||(e=console),e.log("Launch timeout."),setTimeout(()=>{e.log("Timeout done.")},50),e.log("Launch anonymouse promise 1."),new Promise((t,o)=>{y(1e3,!0),e.log("resolve 1"),t(1)}).then(t=>{y(1e3,!0),e.log(`Anonymouse promise resolved to '${t}'.`)}),e.log("Launch anonymouse promise 2."),new Promise((t,o)=>{y(1e3,!0),e.log("resolve 2"),t(2)}).then(t=>{y(1e3,!0),e.log(`Anonymouse promise resolved to '${t}'.`)}),e.log("Script completed.")},j=1;async function k(e){return await new Promise(t=>setTimeout(()=>t(),e))}const f=e=>n.jsx("button",{className:"my-2 mx-1 px-2 py-1 bg-blue-500 text-xl text-white rounded-md hover:bg-blue-600 active:bg-blue-700",...e,children:e.children}),v=e=>{const t="m-1 py-1 px-2 rounded-md border border-neutral-300 text-lg bg-white",o="m-1 py-1 px-2 rounded-md border border-neutral-300 text-lg text-green-500 bg-green-200 font-bold",c="m-1 py-1 px-2 rounded-md border border-neutral-300 text-lg text-red-500 bg-red-200 font-bold";let l=t;e.type==="error"?l=c:e.type==="success"&&(l=o);const s=`${l} ${e.className}`;return n.jsx("span",{...e,className:s,children:e.children})};var u,i,$,a,C,A;class P{constructor(){b(this,a);b(this,u,[]);b(this,i,[]);b(this,$,0)}log(t){m(this,a,C).call(this,n.jsx(v,{children:t}))}logSuccess(t){m(this,a,C).call(this,n.jsx(v,{type:"success",children:t}))}logError(t){m(this,a,C).call(this,n.jsx(v,{type:"error",children:t}))}getAll(){return h(this,u)}clear(){return d(this,u,[]),m(this,a,A).call(this),this}subscribe(t){return d(this,i,[...h(this,i),t]),()=>{d(this,i,h(this,i).filter(o=>o!==h(this,i)))}}getSnapshot(){return this.getAll()}}u=new WeakMap,i=new WeakMap,$=new WeakMap,a=new WeakSet,C=function(t){return d(this,u,[...h(this,u),t]),clearTimeout(h(this,$)),d(this,$,setTimeout(()=>{m(this,a,A).call(this)},250)),this},A=function(){for(let t of h(this,i))t()};const r=new P;let T=0;async function N(e){const t=T++;r.log(`Promise (${t}): Start async work: ${e}.`),await k(500);const o=x.random(1,100);if(o>50)throw`Promise (${t}): Worker (${e}) rejected: error(${o})`;return r.log(`Promise (${t}): Done with the work: ${e}.`),`Promise (${t}): result is ${o}`}function w(e){return N(e)}function E(e){return e=x.toInteger(e),e>0&&e<=128?e:j}async function D(e,t=""){const o=E(e);r.log(`Lunch a batch of ${o} worker(s).`);for(let c=0;c<o;c++)w(t).then(l=>r.logSuccess(`A worker has finished: ${l}`)).catch(l=>r.logError(`A worker has FAILED: ${l}`))}async function R(e,t=""){const o=E(e);r.log(`Lunch a batch of ${o} worker(s).`);for(let c=0;c<o;c++)w(t).then(l=>(r.logSuccess(`A worker has finished: ${l}, queue up another worker.`),w(`Subworker of ${t}`))).then(l=>r.logSuccess(`A subworker has finished: ${l}`)).catch(l=>r.logError(`A worker has FAILED: ${l}`))}async function _(e,t=""){let o=null;const c=E(e);r.log(`Lunch a batch of ${c} worker(s).`);for(let l=0;l<c;l++)o=w(t).then(s=>(r.logSuccess(`Chain 1, resolved & complete: ${s}`),s)).catch(async s=>{if(r.logError(`Chain 1, failed: ${s}`),await k(250),x.random(1)===1)return`Chain 1, restart worker from the failed state: ${s}`;throw Error(`Chain 1, throw an error down the chains: ${s}`)}),o.then(async s=>(r.log(`Chain 2.1, resolved for: ${s}`),await k(250),r.log(`Chain 2.1, did some work for: ${s}`),s)).then(s=>(r.log(`Chain 2.2, resolved: ${s}`),s)).finally(()=>r.log("Chain 2.3, final.")).then(s=>r.logSuccess(`Chain 2.4, resolved & complete: ${s}`)).catch(s=>{}),o.then(s=>{if(x.random(2)>=1)return r.log(`Chain 3, queue up subworker of ${s}`),w(`Subworker of ${s}`).then(g=>r.logSuccess(`Chain 3, subworker resolved & complete: ${g}`)).catch(g=>r.logError(`Chain 3, subwoker failed: ${g}`));r.logSuccess(`Chain 3, resolved & complete: ${s}`)}),o.catch(s=>r.logError(`Chain 4, failed: ${s}`))}const M=()=>{const[e,t]=p.useState(j),[o,c]=p.useState(0),l=p.useSyncExternalStore(x.bind(r.subscribe,r),x.bind(r.getSnapshot,r));return p.useEffect(()=>{window.scrollTo(0,document.body.scrollHeight)},[l]),n.jsxs("div",{className:"my-6 flex flex-col items-center",children:[n.jsx("h2",{className:"mb-6 text-3xl",children:"JavaScript Promise Shenanigans"}),n.jsx("h3",{className:"text-xl",children:"Logs"}),n.jsx("div",{className:"w-[720px] my-6 flex flex-col",children:l.map((s,g)=>n.jsx(p.Fragment,{children:s},g))}),n.jsxs("div",{className:"flex flex-col items-center",children:[n.jsxs("div",{children:[n.jsx("input",{className:"my-2 mx-1 px-2 py-1 w-16 bg-blue-100 text-xl rounded-md",type:"number",min:1,max:128,name:"batchSize",value:e,onChange:s=>t(s.target.value)}),n.jsx(f,{onClick:()=>D(e,"vanilla"),children:"Run v1"}),n.jsx(f,{onClick:()=>R(e,"apple"),children:"Run v2"}),n.jsx(f,{onClick:()=>_(e,"orange"),children:"Run v3"}),n.jsx(f,{onClick:()=>r.clear(),children:"Clear"}),n.jsx(f,{onClick:()=>{c(o+1),t(j),r.clear(),T=0},children:"Reload"})]}),n.jsx("div",{children:n.jsx(f,{onClick:()=>B({logger:r}),children:"Loopy"})})]})]})};export{M as default};
